---
title: rollup搭建工具库
date: 2022-05-16 23:14:09
permalink: /pages/1e2662/
---

## 创建并初始化Github项目

1. 创建Git提交忽略配置 .gitignore

2. 创建开源协议声明 LICENSE

3. 初始化package.json

4. 配置TypeScript tsconfig.json

5. 配置eslint

6. 配置Rollup rollup.config.js

7. 配置jest

### 1 Git提交忽略配置

    touch .gitignore 加入以下内容

    # dependencies
    /node_modules

    # compiled output
    /dist

### 2 创建开源协议声明 LICENSE

创建Github仓库时选择，也可以创建仓库之后再加，一般选择MIT协议

### 3 初始化package.json

    npm init 

增加-y参数是不想一直按Enter

### 4 配置TypeScript tsconfig.json

#### 安装tsc

我们可以使用tsc命令行工具快速创建TypeScript默认配置文件。

先确认下是否安装tsc，输入命令：

    tsc -v

#### 生成tsconfig.json配置文件

    tsc --init 默认的

### 5 配置eslint

    yarn add -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin 

目录结构

    ls-tools
    |- .eslintignore
    |- .eslintrc.js
    |- tsconfig.eslint.json

tsconfig.eslint.json 我们根目录中增加了一个 tsconfig 文件，它将用于 eslintrc.parserOptions.project ，由于该配置要求 incude 每个 ts、js 文件。而我们仅需要打包 src 目录下的代码，所以增加了该配置文件

如果 eslintrc.parserOptions.project 配置为 tsconfig.json 。src 文件以外的 ts、js 文件都会报错。

    Parsing error: "parserOptions.project" has been set for @typescript-eslint/parser.
    The file does not match your project config: config.ts.
    The file must be included in at least one of the projects provided.eslint

复制代码虽然可以配置 eslintrc.parserOptions.createDefaultProgram 但会造成巨大的性能损耗。

#### 配置 tsconfig.eslint.json

    /* tsconfig.eslint.json */
    {
        "compilerOptions": {
            "baseUrl": ".",
            "resolveJsonModule": true,
        },
        "include": [
            "**/*.ts",
            "**/*.js"
        ]
    }

#### 配置 .eslintrc.js

    // .eslintrc.js
    const eslintrc = {
        parser: '@typescript-eslint/parser', // 使用 ts 解析器
        extends: [
            'eslint:recommended', // eslint 推荐规则
            'plugin:@typescript-eslint/recommended', // ts 推荐规则
        ],
        plugins: [
            '@typescript-eslint',
        ],
        env: {
            browser: true,
            node: true,
            es6: true,
        },
        parserOptions: {
            project: './tsconfig.eslint.json',
            ecmaVersion: 2019,
            sourceType: 'module',
            ecmaFeatures: {
            experimentalObjectRestSpread: true
            }
        },
        rules: {}, // 自定义
    }

    module.exports = eslintrc


### 6 配置Rollup rollup.config.js

安装 rollup 以及要用到的插件

    yarn add -D rollup @rollup/plugin-babel @rollup/plugin-commonjs @rollup/plugin-eslint @rollup/plugin-node-resolve @rollup/plugin-typescript rollup-plugin-terser 

TypeScript相关依赖： tslib typescript

安装 babel 相关的库

    yarn add -D @babel/preset-env @babel/core

配置 .babelrc

    {
        "presets": [
            [
            "@babel/preset-env",
            {
                /* Babel 会在 Rollup 有机会做处理之前，将我们的模块转成 CommonJS，导致 Rollup 的一些处理失败 */
                "modules": false
            }
            ]
        ],
        "plugins": ["@babel/plugin-transform-runtime"]
        //"
    }

配置 rollup.config.js

    import path from 'path'
    import typescript from '@rollup/plugin-typescript'
    import babel from '@rollup/plugin-babel'
    import resolve from '@rollup/plugin-node-resolve'
    import commonjs from '@rollup/plugin-commonjs'
    import { eslint } from '@rollup/plugin-eslint'
    import { DEFAULT_EXTENSIONS } from '@babel/core'

    import pkg from './package.json'

    const paths = {
        input: path.join(__dirname, '/src/index.ts'),
        output: path.join(__dirname, '/lib'),
    }

    // rollup 配置项
    const rollupConfig = {
        input: paths.input,
        output: [
            // 输出 commonjs 规范的代码
            {
                file: path.join(paths.output, 'index.js'),
                format: 'cjs',
                name: pkg.name,
            },
            // 输出 es 规范的代码
            {
                file: path.join(paths.output, 'index.esm.js'),
                format: 'es',
                name: pkg.name,
            },
        ],
        // external: ['lodash'], // 指出应将哪些模块视为外部模块，如 Peer dependencies 中的依赖
        // plugins 需要注意引用顺序
        plugins: [
            // 验证导入的文件
            eslint({
                throwOnError: true, // lint 结果有错误将会抛出异常
                throwOnWarning: true,
                include: ['src/**/*.ts'],
                exclude: ['node_modules/**', 'lib/**', '*.js'],
            }),

            // 使得 rollup 支持 commonjs 规范，识别 commonjs 规范的依赖
            commonjs(),

            // 配合 commnjs 解析第三方模块
            resolve({
            // 将自定义选项传递给解析插件
                customResolveOptions: {
                    moduleDirectory: 'node_modules',
                },
            }),
            typescript(),
            babel({
                runtimeHelpers: true,
                // 只转换源代码，不运行外部依赖
                exclude: 'node_modules/**',
                // babel 默认不支持 ts 需要手动添加
                extensions: [
                    ...DEFAULT_EXTENSIONS,
                    '.ts',
                ],
            }),
        ],
    }

    export default rollupConfig

### 7 配置 jest

    yarn add -D @types/jest eslint-plugin-jest jest ts-jest

目录

    ls-tools
        |- test
            |- index.test.ts
        |- jest.config.js

配置 jest.config.js

    // jest.config.js
    module.exports = {
        preset: 'ts-jest',
        testEnvironment: 'node',
    }

再配置 eslint

    const eslintrc = {
        // ...
        extends: [
            // ...
            'plugin:jest/recommended',
        ],
        plugins: [
            // ...
            'jest',
        ],
        // ...
    }

增加 package.json scripts

    "test": "jest --coverage --verbose -u"

- coverage 输出测试覆盖率
- verbose 层次显示测试套件中每个测试的结果，会看着更加直观啦

    yarn test
=