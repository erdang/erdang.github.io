---
title: Babel
date: 2022-04-22 14:13:23
permalink: /pages/b0b059/
---

## Babel

`Babel` 是一个工具链，主要用于将采用 `ECMAScript 2015+` 语法编写的代码转换为向后兼容的 `JavaScript 语法`，以便能够运行在当前和旧版本的浏览器或其他环境中。

我们一般用 Babel 做下面几件事：

* 语法转换（`es-higher` -> `es-lower`）;
* 通过 `Polyfill` 处理在目标环境无法转换的特性（通过 `core-js` 实现）;
* 源码转换（`codemods`、`jscodeshift`）;
* 静态分析（`lint`、根据注释生成 `API` 文档等）;

## 关于Babel版本

目前，前端开发领域使用的Babel版本主要的Babel6和Babel7这两个版本。

Babel是一个工具集，而这个工具集是围绕@babel/core这个核心npm包构成的。每次@babel/core发布新版本的时候，整个工具集的其它npm包也都会跟着升级到与@babel/core相同的版本号，即使它们的代码可能一行都没有改变。

Babel7的npm包都是放在babel域下的，即在安装npm包的时候，我们是安装@babel/这种方式，例如@babel/cli、@babel/core等。而在Babel6，我们安装的包名是babel-cli，babel-core等。其实它们本质是一样的，都是Babel官方的cli命令行工具和core核心包，而且功能是一样的，只是名称版本变化了一下而已。在平时开发和学习的过程中，碰到'@babel/'和'babel-'应该下意识认识到他俩原本是一个包，只是版本不一样而已。

## Babel 配置文件

Babel的配置文件是Babel执行时默认会在当前目录寻找的文件，主要有.babelrc，.babelrc.js，babel.config.js和package.json。它们的配置项都是相同，作用也是一样的，只需要选择其中一种。

对于.babelrc，它的配置是这样子

    {
        "presets": ["es2015", "react"],
        "plugins": ["transform-decorators-legacy", "transform-class-properties"]
    }

对于babel.config.js和.babelrc.js，它的配置是一样的，通过module.exports输出配置项

    module.exports = {
        "presets": ["es2015", "react"],
        "plugins": ["transform-decorators-legacy", "transform-class-properties"]
    }

对于package.json，就是在package.json中增加一个babel属性和值，它的配置是这样子

    {
        "name": "demo",
        "version": "1.0.0",
        "description": "",
        "main": "index.js",
        "scripts": {
            "test": "echo \"Error: no test specified\" && exit 1"
        },
        "author": "",
        "babel": {
            "presets": ["es2015", "react"],
            "plugins": ["transform-decorators-legacy", "transform-class-properties"]
        }
    }

在webpack配置文件中，我们把babel-loader添加到module的loaders列表中：

    module: {
        rules: [
        {
            test: /\.js$/,
            exclude: /(node_modules|bower_components)/,
            use: {
            loader: 'babel-loader',
            options: {
                presets: ['@babel/preset-env']
            }
            }
        }
        ]
    }

在这里，我们通过options属性给babel-loader传递预设和插件等Babel配置项。我们也可以省略这个options，这个时候babel-loader会去读取默认的Babel配置文件，也就是.babelrc，.babelrc.js，babel.config.js等。在现在的前端开发中，建议通过配置文件来传递这些配置项。

## 插件与预设

plugin代表插件，preset代表预设，它们分别放在plugins和presets，每个插件或预设都是一个npm包。

plugins插件数组和presets预设数组是有顺序要求的。如果两个插件或预设都要处理同一个代码片段，那么会根据插件和预设的顺序来执行。规则如下

* 插件比预设先执行
* 插件执行顺序是插件数组从前向后执行
* 预设执行顺序是预设数组从后向前执行

### preset预设的选择

在Babel6的时代 ,很复杂,一言难尽 ,现在只需一个`@babel/preset-env`就可以了

在实际开发过程中，除了使用@babel/preset-env对标准的ES6语法转换，我们可能还需要类型检查和react等预设对特定语法转换。这里有三个官方预设可以使用：

    * @babel/preset-flow
    * @babel/preset-react
    * @babel/preset-typescript

总结起来，Babel官方的preset，我们实际可能会用到的其实就只有4个：

    * @babel/preset-env
    * @babel/preset-flow
    * @babel/preset-react
    * @babel/preset-typescript

一个普通的vue工程，Babel官方的preset只需要配一个"@babel/preset-env"就可以了

#### @babel/preset-env

在Babel6时代，这个预设名字是 babel-preset-env，在Babel7之后，改成@babel/preset-env。除了进行语法转换，该预设还可以通过设置参数项进行针对性语法转换以及polyfill的按需引入

在使用它之前，需要先安装

     npm install --save-dev @babel/core @babel/cli @babel/preset-env 

以babel.config.js 为例,对于preset，当我们不需要对其设置参数的时候

    module.exports = {
        presets: ["@babel/preset-env"],
        plugins: []
    }

**targets** 该参数项可以取值为字符串、字符串数组或对象，默认{},targets > browserslist(都没设置 全部es6=>es5)

    module.exports = {
        presets: [["@babel/env", {
        targets: {
            "chrome": "58",
            "ie": "11"
        },
        "useBuiltIns": "usage",
        "corejs": 3
        }]],
        plugins: []
    }
 
 **useBuiltIns** 默认值false

        usage：每个文件引用使用到的特性； 
        entry：入口处全部引入；
        false：不引入
        entry：需要 入口文件    import "core-js/stable";
                              import "regenerator-runtime/runtime";
    corejs 3

ps:Browserslist叫做目标环境配置表，除了写在package.json里，也可以单独写在工程目录下.browserslistrc文件里。我们用browserslist来指定代码最终要运行在哪些浏览器或node.js环境。Autoprefixer、postcss等就可以根据我们的browserslist，来自动判断是否要增加CSS前缀（例如'-webkit-'）。我们的Babel也可以使用browserslist，如果你使用了@babel/preset-env这个预设，此时Babel就会读取browserslist的配置。

如果我们的@babel/preset-env不设置任何参数，Babel就会完全根据browserslist的配置来做语法转换。如果没有browserslist，那么Babel就会把所有ES6的语法转换成ES5版本。

### plugin插件的选择

虽然Babel7官方有90多个插件，不过大半已经整合在@babel/preset-env和@babel/preset-react等预设里了，我们在开发的时候直接使用预设就可以了。

目前比较常用的插件只有@babel/plugin-transform-runtime。

